## 스코프의 종류

스코프는 크게 **전역(Global) 스코프**와 **지역(Local) 스코프**로 나눌 수 있습니다.
변수는 어느 영역에 선언되었는지에 따라 자신의 유효 범위, 즉 스코프가 결정됩니다.
- **전역 스코프(Global Scope)**: 코드의 가장 바깥 영역을 의미합니다. 전역에 선언된 변수는 **전역 변수**가 되며, 프로그램의 **어디서든 접근**할 수 있습니다.
- **지역 스코프(Local Scope)**: **함수 몸체 내부**를 의미합니다. 함수 내부에 선언된 변수는 **지역 변수**가 되며, 해당 함수와 그 함수 내에 중첩된 **하위 함수에서만 접근**할 수 있습니다.
```javascript
var x = 'global x';
var y = 'global y';

function outer() {
  var z = "outer's local z";

  console.log(x); // 1. global x
  console.log(y); // 2. global y
  console.log(z); // 3. outer's local z

  function inner() {
    var x = "inner's local x"; // 가장 가까운 x를 사용

    console.log(x); // 4. inner's local x
    console.log(y); // 5. global y
    console.log(z); // 6. outer's local z
  }

  inner();
}

outer();

console.log(x); // 7. global x
console.log(z); // 8. ReferenceError: z is not defined
```

### 전역 스코프(Global Scope)

**전역**이란 코드의 가장 바깥 영역을 의미하며, 이 공간이 바로 **전역 스코프**를 만듭니다.
- **전역 변수**: 전역 스코프에 선언된 변수를 **전역 변수(Global Variable)** 라고 합니다.
- **특징**: 전역 변수는 프로그램의 **어디서든 자유롭게 참조**할 수 있습니다. 함수 내부에서도 당연히 접근 가능하죠. 
```javascript
var x = 'global x'; // 전역 변수
var y = 'global y'; // 전역 변수

function outer() {
  // ...
}
console.log(x); // global x 
console.log(y); // global y
```

### 지역 스코프

**지역**이란 **함수 몸체 `{}` 내부**를 의미하며, 이 함수만의 독립된 공간인 **지역 스코프**를 만듭니다.
- **지역 변수**: 지역 스코프에 선언된 변수를 **지역 변수(Local Variable)** 라고 합니다.
- **특징**: 지역 변수는 오직 **자신이 선언된 함수와 그 함수 내에 중첩된 하위 함수에만 유효**합니다. 함수 외부(상위 스코프)에서는 해당 변수에 접근할 수 없습니다.
```javascript
// ... (이전 코드)

function outer() {
  var z = "outer's local z"; // outer 함수의 지역 변수

  function inner() {
    var x = "inner's local x"; // inner 함수의 지역 변수
    
    // inner 함수 안에서는 상위 스코프 변수인 z에 접근 가능
    console.log(z); // "outer's local z"
  }

  inner();
}

outer();

// 전역 스코프에서는 outer 함수의 지역 변수인 z에 접근 불가
console.log(z); // ReferenceError: z is not defined
```
이처럼 자바스크립트 엔진이 어떤 변수를 참조할지 결정할 때, 먼저 자신이 속한 스코프를 살피고,
없다면 상위 스코프로 거슬러 올라가며 변수를 찾는 **스코프 체인** 규칙을 따르기 때문에 위와 같은 결과가 나오는 것입니다.


## 스코프 체인 (Scope Chain)

함수는 다른 함수 몸체 내부에 정의될 수 있는데, 이를 **함수의 중첩**이라고 합니다.
이렇게 함수가 중첩되면 스코프 또한 계층적인 구조를 갖게 됩니다.

**스코프 체인**이란 이처럼 스코프가 계층적으로 연결된 것을 말합니다. 모든 지역 스코프의 최상위에는 전역 스코프가 존재하며, 이 체인은 마치 꼬리처럼 연결되어 있습니다.

예를들어 `inner`함수 스코프가 '쌍문동'이라면 그를 감싸는 `outer`함수 스코프는 '도봉구', 그리고 최상위 전역 스코프는 '서울시'와 같습니다.
'쌍문동'은 '도봉구'에 속하고, '도봉구'는 '서울시'에 속하는 계층적 구조와 동일합니다.

이러한 스코프 체인은 자바스크립트 엔진이 특정 변수나 함수를 찾아 나서는 **검색 규칙**으로 작동합니다.


### 예제 분석

예제를 다시 확인해 스코프 체인의 동작을 확인해 보겠습니다.
```javascript
var x = 'global x';
var y = 'global y';

function outer() {
  var z = "outer's local z";

  console.log(x); // 1. global x
  console.log(y); // 2. global y
  console.log(z); // 3. outer's local z

  function inner() {
    var x = "inner's local x"; // 가장 가까운 x를 사용

    console.log(x); // 4. inner's local x
    console.log(y); // 5. global y
    console.log(z); // 6. outer's local z
  }

  inner();
}

outer();

console.log(x); // 7. global x
console.log(z); // 8. ReferenceError: z is not defined
```
- **4번 `console.log(x)`**: `inner` 함수는 자신의 스코프에서 `x`를 바로 찾았으므로 검색을 종료하고 `inner's local x`를 출력합니다.
- **5번 `console.log(y)`**: `inner` 스코프에 `y`가 없으므로 상위인 `outer` 스코프로 이동합니다. `outer`에더 없으므로 다시 상위인 전역 스코프로 이동해 `y`를 찾아 출력합니다.
- **6번 `console.log(z)`**: `inner` 스코프에 `z`가 없으므로 상위인 `outer` 스코프로 이동해 `z`를 찾아 출력합니다.
- **8번 `console.log(z)`**: 전역 스코프에서는 `outer` 함수의 지역 변수인 `z`에 접근할 수 없으므로 참조 에러가 발생합니다.

### 렉시컬 환경 (Lexical Environment)

스코프 체인은 눈에 보이지 않는 개념이 아니라, **렉시컬 환경**이라는 자료구조를 통해 물리적으로 존재합니다.
자바스크립트 엔진은 코드를 실행하기 전, 각 스코프에 대한 정보를 담은 **렉시컬 환경**을 생성합니다.

**렉시컬 환경**은 두 가지 요소로 구성됩니다.
1. **환경 레코드 (Environment Record)**: 스코프 내에 선언된 변수와 함수 식별자를 **키(key)** 로, 할당된 값을 **값(value)** 으로 기록하는 공간힙니다.
2. **외부 렉시컬 환경에 대한 참조(Outer Lexical Environment Reference)**: 상위 스코프의 렉시컬 환경을 가리키는 포인터입니다. 이 참조가 바로 스코프 체인의 연결고리 역할을 합니다.

엔진이 변수를 찾을 때, 현재 실행 중인 코드의 렉시컬 환경을 시작으로 '외부 렉시컬 환경에 대한 참조'를 따라 상위 환경으로 계속 이동하며 식별자를 검색하는 것입니다.


## 스코프 체인에 의한 함수 검색

함수 역시 변수처럼 식별자에 할당되므로, 함수를 검색하는 방식도 스코프 체인 규칙을 그대로 따릅니다.
```javascript
function foo() {
  console.log('global function foo');
}

function bar() {
  // bar의 지역 스코프에 foo 함수가 선언됨
  function foo() {
    console.log('local function foo');
  }

  foo(); // 가장 가까운 local foo를 호출
}

bar(); // 결과: "local function foo"
```
`bar()`를 실행하면, 자바스크립트 엔진은 `foo()`를 호출하기 위해 먼저 `bar`의 지역 스코프를 검색합니다.
여기서 `'local function foo'`를 찾았기 때문에 검색을 멈추고 즉시 실행합니다.
전역에 있는 `foo`함수는 검색 대상이 되지 않습니다.

따라서 **스코프**는 "변수를 검색하는 규칙"을 넘어 **"식별자를 검색하는 규칙"** 이라고 이해하는 것이 더 정확합니다.